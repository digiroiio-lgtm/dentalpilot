generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  COORDINATOR
  DOCTOR
  VIEWER
}

enum LeadStage {
  INITIAL_CONTACT
  WAITING_PHOTOS
  QUOTE_SENT
  POSITIVE
  DEAL_CONFIRMED
  LOST
}

enum ActivityType {
  PHONE_CALL
  WHATSAPP
  EMAIL
  IN_PERSON
  VIDEO_CALL
  SYSTEM
}

enum ActivityOutcome {
  REACHED
  NOT_REACHED
  QUOTE_SENT
  INFO_PROVIDED
  CALLBACK_REQUESTED
}

enum TreatmentPlanStatus {
  DRAFT
  SENT_TO_PATIENT
  ACCEPTED
  REJECTED
}

enum Currency {
  GBP
  EUR
  USD
  TRY
}

enum LostReasonCategory {
  PRICE_FINANCIAL
  PATIENT_INTEREST
  COMPETITOR
  COMMUNICATION
  MEDICAL
  LOGISTICS
  OTHER
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  passwordHash  String
  role          Role     @default(COORDINATOR)
  leadsOwned    Lead[]   @relation("LeadOwner")
  tasks         Task[]
  activities    Activity[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Lead {
  id                String       @id @default(cuid())
  firstName         String
  lastName          String
  gender            String?
  birthDate         DateTime?
  country           String
  phone             String
  email             String?
  whatsappEnabled   Boolean      @default(false)
  communicationPref String?
  source            String
  referenceName     String?
  referenceNote     String?
  leadDate          DateTime     @default(now())
  stage             LeadStage    @default(INITIAL_CONTACT)
  owner             User?        @relation("LeadOwner", fields: [ownerId], references: [id])
  ownerId           String?
  nextFollowUpDate  DateTime?
  status            String       @default("ACTIVE")
  lastActivityAt    DateTime?
  totalPlanPrice    Float?
  consentGiven      Boolean      @default(false)
  consentDate       DateTime?
  consentFileUrl    String?
  marketingOptIn    Boolean      @default(false)

  tasks          Task[]
  activities     Activity[]
  treatmentPlans TreatmentPlan[]
  lostReason     LostReason?
  files          LeadFile[]
  deal           Deal?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LostReason {
  id          String             @id @default(cuid())
  lead        Lead               @relation(fields: [leadId], references: [id])
  leadId      String             @unique
  category    LostReasonCategory
  reasonKey   String
  description String?
  createdAt   DateTime           @default(now())
}

model LeadFile {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id])
  leadId    String
  type      String
  url       String
  createdAt DateTime @default(now())
}

model TreatmentPlan {
  id                  String               @id @default(cuid())
  lead                Lead                 @relation(fields: [leadId], references: [id])
  leadId              String
  name                String
  status              TreatmentPlanStatus  @default(DRAFT)
  currency            Currency             @default(GBP)
  subtotal            Float?
  discount            Float?
  total               Float?
  includesHotel       Boolean              @default(false)
  includesTransfer    Boolean              @default(false)
  includesMedications Boolean              @default(false)
  note                String?
  items               TreatmentPlanItem[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model TreatmentPlanItem {
  id              String        @id @default(cuid())
  treatmentPlan   TreatmentPlan @relation(fields: [treatmentPlanId], references: [id])
  treatmentPlanId String
  priceItem       PriceItem?    @relation(fields: [priceItemId], references: [id])
  priceItemId     String?
  title           String
  description     String?
  quantity        Int           @default(1)
  unitPrice       Float
  lineTotal       Float
}

model PriceItem {
  id        String   @id @default(cuid())
  category  String
  name      String
  code      String?
  currency  Currency @default(GBP)
  unitPrice Float
  note      String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     TreatmentPlanItem[]
}

model Task {
  id          String   @id @default(cuid())
  lead        Lead     @relation(fields: [leadId], references: [id])
  leadId      String
  title       String
  description String?
  dueDate     DateTime?
  status      String   @default("OPEN")
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  assigneeId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Activity {
  id            String          @id @default(cuid())
  lead          Lead            @relation(fields: [leadId], references: [id])
  leadId        String
  type          ActivityType
  outcome       ActivityOutcome?
  note          String?
  performedBy   User?           @relation(fields: [performedById], references: [id])
  performedById String?
  createdAt     DateTime        @default(now())
}

model Hotel {
  id        String   @id @default(cuid())
  name      String
  email     String
  address   String?
  note      String?
  active    Boolean  @default(true)
  deals     Deal[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TransferCompany {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  note      String?
  active    Boolean  @default(true)
  deals     Deal[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique
  subject   String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClinicSetting {
  id              String   @id @default(cuid())
  clinicName      String
  address         String?
  primaryEmail    String
  defaultCurrency Currency @default(GBP)
  logoUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Deal {
  id                 String           @id @default(cuid())
  lead               Lead             @relation(fields: [leadId], references: [id])
  leadId             String           @unique
  treatmentPlan      TreatmentPlan?   @relation(fields: [treatmentPlanId], references: [id])
  treatmentPlanId    String?
  totalPrice         Float?
  currency           Currency         @default(GBP)
  arrivalDate        DateTime?
  departureDate      DateTime?
  flightIn           String?
  flightOut          String?
  hotel              Hotel?           @relation(fields: [hotelId], references: [id])
  hotelId            String?
  hotelRoomType      String?
  nights             Int?
  extraGuestName     String?
  transferCompany    TransferCompany? @relation(fields: [transferCompanyId], references: [id])
  transferCompanyId  String?
  meetAndGreetNote   String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}
